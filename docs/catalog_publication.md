# Catalog Publication Tool

The `scripts/publish_power_estimates_catalog.py` helper turns the artefacts
generated by the power-estimation pipeline into a versioned, reproducible
catalogue located under `use_case/catalogs/sar_range_final_power_estimates/`. It performs
the following actions:

1. Resolves the ANN inference GeoParquet through the local STAC index
   (`config/stac_catalogs.json`) and extracts the node geometries using DuckDB.
2. Joins the per-node summary metrics (`artifacts/power_estimates/power_estimates_summary.csv`)
   and empirical QA indicators (`artifacts/empirical_metrics/per_node_summary.csv`).
3. Writes the resulting table to `assets/power_estimates_nodes.parquet` with the
   geometry column preserved in CRS84.
4. Generates a `manifest.json` capturing input checksums, processing parameters,
   and the code commit SHA.
5. Creates a STAC collection (`collection.json`) and item
   (`items/power_estimates_nodes.json`) that mirror the structure of the input
   dataset while adding version and provenance metadata.
6. Updates the root catalogue (`use_case/catalogs/catalog.json`) so the new collection is
   discoverable alongside the ANN input data.

## Usage

Run the script after `scripts/generate_power_estimates.py` (and the empirical
metrics pipeline) have produced the CSV artefacts:

```bash
python3 scripts/publish_power_estimates_catalog.py --overwrite
```

- The command defaults to using the `duckdb/duckdb:latest` container; pass
  `--engine python` if the DuckDB Python package is available locally.
- Use `--version-tag` to publish a different snapshot name (the default is
  `sar-range-final-20251018`).
- The script accepts `--stac-config` and `--stac-dataset` switches to target an
  alternative STAC index entry if a new ANN snapshot is introduced.
- All paths written to `manifest.json` are repository-relative and include
  SHA-256 checksums for reproducibility.

After the command finishes, the catalogue can be shared directly: it only
contains the GeoParquet dataset and associated metadata (no CSVs or auxiliary
files beyond the manifest). To refresh the catalogue, rerun the script with
`--overwrite` once the upstream artefacts are updated.
